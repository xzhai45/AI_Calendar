{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block title %}Home | GT AI Calendar{% endblock title %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet" />
{% endblock %}

{% block content %}
<div class="container mt-5 text-center">
    <h1>Welcome to GT AI Calendar</h1>
    <p>Your AI-powered scheduling assistant</p>
</div>
<div class="container mt-3">
    <details>
        <summary class="text-muted">Debug Info (click to expand)</summary>
        <pre>{{ events|safe }}</pre>
        <pre>{{ calendars|safe }}</pre>
    </details>
</div>

<div class="container mt-5">
    <div class="row">
        <!-- Calendar Selector -->
        <div class="col-md-4">
            {% if user.is_authenticated and calendars %}
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">My Calendars</h5>
                </div>
                <div class="card-body">
                    <form id="calendar-form">
                        {% for cal in calendars %}
                        <div class="form-check">
                            <input class="form-check-input calendar-toggle" type="checkbox" name="calendars"
                                value="{{ cal.id }}" checked>
                            <label class="form-check-label">{{ cal.name }}</label>
                        </div>
                        {% endfor %}
                    </form>

                    <button id="add-event-toggle" class="btn btn-outline-primary btn-sm mt-3 w-100">+ Add Event</button>
                    <form id="manual-event-form" class="border p-3 rounded shadow-sm bg-light d-none">
                        <div class="mb-2">
                            <input type="text" class="form-control form-control-sm" placeholder="Title" id="manual-title"
                                required>
                        </div>
                        <div class="mb-2">
                            <input type="datetime-local" class="form-control form-control-sm" id="manual-start" required>
                        </div>
                        <div class="mb-2">
                            <input type="datetime-local" class="form-control form-control-sm" id="manual-end" required>
                        </div>
                        <div class="mb-2">
                            <input type="text" class="form-control form-control-sm" placeholder="Location"
                                id="manual-location">
                        </div>
                        <div class="mb-2">
                            <input type="text" class="form-control form-control-sm" placeholder="Description"
                                id="manual-description">
                        </div>
                        <button type="submit" class="btn btn-sm btn-success w-100">Save</button>
                    </form>

                    
                    <!-- AI Calendar Query Form -->
                    <div class="card mt-4 shadow-sm">
                        <div class="card-body">
                            <form id="ai-query-form">
                                <div class="mb-3">
                                    <label for="ai-input" class="form-label">AI Calendar Query:</label>
                                    <textarea id="ai-input" class="form-control form-control-sm" rows="3"
                                        placeholder="e.g., Meeting next Tuesday..."></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="ai-file" class="form-label">PDF Upload</label>
                                    <input type="file" class="form-control form-control-sm" id="ai-file" name="file">
                                </div>
                                <button type="submit" class="btn btn-sm btn-primary w-100">Submit Query</button>
                            </form>
                            <div id="ai-response" class="mt-2 d-none alert alert-secondary"></div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        

        <!-- Calendar View -->
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">My Schedule</h5>
                </div>
                <div class="card-body">
                    <div id="calendar"></div>
                </div>
            </div>
        </div>
    </div>

    {% if user.is_authenticated %}
    <!-- Chat History and Suggested Events -->
    <div class="card mt-4 shadow-sm" id="chat-container">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">üóÇÔ∏è Chat History</h5>
        </div>
        <div class="card-body">
            <div id="chat-history" class="mb-3">
                <!-- Session queries and file summaries go here -->
            </div>
            <div id="event-suggestions" class="mt-4">
                <!-- Events suggested by LLM will appear here -->
            </div>
            <button id="submit-all-events" class="btn btn-success mt-3 d-none">Submit All Events</button>
        </div>
    </div>
    {% endif %}
    {% if not user.is_authenticated %}
    <!-- Guest user form -->
    <div class="card mt-4 shadow-sm">
        <div class="card-body">
            <form id="guest-ai-form">
                <div class="mb-3">
                    <label for="guest-ai-input" class="form-label">AI Calendar Trial (Guest):</label>
                    <textarea id="guest-ai-input" class="form-control form-control-sm" rows="3"
                        placeholder="e.g., Study session next Friday..."></textarea>
                </div>
                <div class="mb-3">
                    <label for="guest-ai-file" class="form-label">Optional PDF Upload</label>
                    <input type="file" class="form-control form-control-sm" id="guest-ai-file" name="file">
                </div>
                <button type="submit" class="btn btn-sm btn-primary w-100">Submit Trial</button>
            </form>
            <div id="guest-ai-response" class="mt-2 d-none alert alert-info"></div>
        </div>
    </div>
    <table id="guest-ai-table" class="table table-sm table-striped d-none mt-3">
        <thead class="table-light">
            <tr>
                <th>Title</th>
                <th>Start</th>
                <th>End</th>
                <th>Location</th>
                <th>Description</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>     
    {% endif %}

    </div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    document.addEventListener('DOMContentLoaded', function () {
        console.log("üí° DOM fully loaded. JS running.");
        const aiForm = document.getElementById('ai-query-form');
        const aiResponseBox = document.getElementById('ai-response');
    
        if (!aiForm) {
            console.error("aiForm not found in DOM.");
            return;
        }
    
        aiForm.addEventListener('submit', function (e) {
            console.log("AI form submit triggered.");
            e.preventDefault();
    
            const query = document.getElementById('ai-input').value.trim();
            const fileInput = document.getElementById('ai-file').files[0];
    
            if (!query && !fileInput) {
                alert("Please provide a query or upload a file.");
                return;
            }
    
            const formData = new FormData();
            formData.append("query", query);
            if (fileInput) {
                formData.append("file", fileInput);
            }
    
            fetch('/ai-process-query/', {
                method: 'POST',
                headers: { 'X-CSRFToken': getCookie('csrftoken') },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert("ERROR" + data.error);
                    return;
                }
    
                fetch('/chat-history/')
                    .then(res => res.json())
                    .then(data => {
                        if (data.history) {
                            displayChatHistory(data.history);
                        }
                        console.log("/chat-history/ returned:", data);
                    });
    
                if (data.processing) {
                    console.log("Starting pollSuggestedEvents...");
                    pollSuggestedEvents();
                }
    
                aiResponseBox.classList.remove('d-none');
                aiResponseBox.textContent = "‚úÖ Submitted. Waiting for AI to respond with events...";
                document.getElementById('ai-input').value = '';
                document.getElementById('ai-file').value = '';
            })
            .catch(err => {
                console.error("Error submitting query:", err);
                alert("Error submitting query.");
            });
        });
    
        const allEvents = [
            {% for event in events %}
            {
                title: "{{ event.summary|escapejs }}",
                start: "{{ event.start|escapejs }}",
                end: "{{ event.end|escapejs }}",
                backgroundColor: "{{ event.backgroundColor|default:'#3788d8' }}",
                calendarId: "{{ event.calendarId|escapejs }}",
                extendedProps: {
                    location: "{{ event.location|escapejs }}",
                    description: "{{ event.description|escapejs }}",
                    creator: "{{ event.creator|escapejs }}",
                    htmlLink: "{{ event.htmlLink|escapejs }}",
                    googleEventId: "{{ event.googleEventId|escapejs }}"
                }
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];
    
        const calendarEl = document.getElementById('calendar');
        const checkboxes = document.querySelectorAll('.calendar-toggle');
        let calendar = null;
    
        if (calendarEl) {
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                height: 'auto',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,listWeek'
                },
                events: allEvents,
                eventClick: function (info) {
                    const props = info.event.extendedProps;
                    const title = info.event.title;
                    const start = info.event.start.toLocaleString();
                    const end = info.event.end ? info.event.end.toLocaleString() : 'N/A';
                    const location = props.location || 'N/A';
                    const description = props.description || 'N/A';
                    const creator = props.creator || 'N/A';
    
                    const confirmDelete = confirm(
                        `Title: ${title}\nStart: ${start}\nEnd: ${end}\nLocation: ${location}\nDescription: ${description}\nCreator: ${creator}\n\nDo you want to delete this event?`
                    );
    
                    if (confirmDelete) {
                        fetch('/delete-event/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCookie('csrftoken')
                            },
                            body: JSON.stringify({
                                eventId: props.googleEventId,
                                calendarId: props.calendarId || "primary"
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.error) {
                                alert("ERROR" + data.error);
                                return;
                            }
                            fetch('/chat-history/')
                                .then(res => res.json())
                                .then(data => {
                                    if (data.history) {
                                        displayChatHistory(data.history);
                                    }
                                });
                            alert("Event deleted from Google Calendar.");
                        })
                        .catch(error => {
                            console.error("Delete error:", error);
                            alert("Error deleting event.");
                        });
                    }
                }
            });
            calendar.render();
    
            checkboxes.forEach(cb => {
                cb.addEventListener('change', () => {
                    const selectedCalendars = Array.from(checkboxes)
                        .filter(c => c.checked)
                        .map(c => c.value);
                    const filteredEvents = allEvents.filter(ev => selectedCalendars.includes(ev.calendarId));
                    calendar.removeAllEvents();
                    calendar.addEventSource(filteredEvents);
                });
            });
        }
    
        fetch('/chat-history/')
            .then(res => res.json())
            .then(data => {
                if (data.history) {
                    displayChatHistory(data.history);
                }
            });
    
        fetch('/suggested-events/')
            .then(res => res.json())
            .then(data => {
                if (data.suggested_events) {
                    displaySuggestedEvents(data.suggested_events);
                }
            });
    
        document.getElementById('add-event-toggle').addEventListener('click', function () {
            document.getElementById('manual-event-form').classList.toggle('d-none');
        });
    
        const manualForm = document.getElementById('manual-event-form');
        if (manualForm) {
            manualForm.addEventListener('submit', function (e) {
                e.preventDefault();
    
                const title = document.getElementById('manual-title').value;
                const startRaw = document.getElementById('manual-start').value;
                const endRaw = document.getElementById('manual-end').value;
                const location = document.getElementById('manual-location').value;
                const description = document.getElementById('manual-description').value;
    
                function toRFC3339(datetime) {
                    return new Date(datetime).toISOString();
                }
    
                const start = toRFC3339(startRaw);
                const end = toRFC3339(endRaw);
    
                if (new Date(start) >= new Date(end)) {
                    alert("End time must be after start time.");
                    return;
                }
    
                fetch('/add-event/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: new URLSearchParams({
                        title,
                        start,
                        end,
                        location,
                        description
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.message) {
                        alert("Event added to Google Calendar!");
                        manualForm.classList.add('d-none');
                        manualForm.reset();
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        alert("ERROR" + (data.error || "Failed to add event."));
                    }
                })
                .catch(err => {
                    console.error("Network error adding event:", err);
                    alert("Submission failed.");
                });
            });
        }
    });
    
    function displayChatHistory(history) {
        console.log("üìú Rendering chat history:", history);
        const container = document.getElementById("chat-history");
        container.innerHTML = "";
        history.forEach((entry, index) => {
            const card = document.createElement("div");
            card.className = "card mb-2 shadow-sm";
            card.innerHTML = `
                <div class="card-body">
                    <h6>Query ${index + 1}:</h6>
                    <p><strong>Input:</strong> ${entry.query || "<em>None</em>"}</p>
                    ${entry.file_text ? `<p><strong>PDF Preview:</strong><br><small>${entry.file_text.substring(0, 300)}...</small></p>` : ""}
                </div>
            `;
            container.appendChild(card);
        });
    }
    
    function displaySuggestedEvents(events) {
        console.log("displaySuggestedEvents called with:", events);
        const container = document.getElementById('event-suggestions');
        container.innerHTML = '';
        if (!events || events.length === 0) {
            container.innerHTML = "<p class='text-muted'>No event suggestions available.</p>";
            return;
        }

        const isAuthenticated = {{ user.is_authenticated|yesno:"true,false" }};

    
        events.forEach((event, idx) => {
            const div = document.createElement('div');
            div.className = "card mb-2 shadow-sm";
            const safe = (key, fallback = "") => event[key] || fallback;
            div.innerHTML = `
                <div class="card-body">
                    <h6>Suggested Event ${idx + 1}</h6>
                    <div class="mb-2">
                    <label>Title:</label>
                    <input type="text" class="form-control form-control-sm" id="title-${idx}" value="${safe("title")}" />
                    </div>
                    <div class="mb-2">
                    <label>Start:</label>
                    <input type="datetime-local" class="form-control form-control-sm" id="start-${idx}" value="${safe("start")}" />
                    </div>
                    <div class="mb-2">
                    <label>End:</label>
                    <input type="datetime-local" class="form-control form-control-sm" id="end-${idx}" value="${safe("end")}" />
                    </div>
                    <div class="mb-2">
                    <label>Location:</label>
                    <input type="text" class="form-control form-control-sm" id="location-${idx}" value="${safe("location")}" />
                    </div>
                    <div class="mb-2">
                    <label>Description:</label>
                    <input type="text" class="form-control form-control-sm" id="description-${idx}" value="${safe("description")}" />
                    </div>
                    <button class="btn btn-sm btn-success" onclick='submitEditedEvent(${idx})'>Submit</button>
                </div>
                `;
            container.appendChild(div);
        });
    }
    
    function submitSuggestedEvent(eventStr) {
        const event = JSON.parse(eventStr);
        if (!event.title || !event.start || !event.end) {
            alert("Missing required fields.");
            return;
        }
    
        fetch('/add-event/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: new URLSearchParams({
                title: event.title,
                start: event.start,
                end: event.end,
                location: event.location || '',
                description: event.description || ''
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                alert("ERROR" + data.error);
            } else {
                alert("Event submitted to Google Calendar!");
            }
        })
        .catch(err => {
            console.error("Error submitting suggested event:", err);
            alert("Submission failed.");
        });
    }
    
    function pollSuggestedEvents() {
        console.log("pollSuggestedEvents() called");
        const pollInterval = setInterval(() => {
            fetch('/poll-llm-status/')
                .then(res => res.json())
                .then(data => {
                    console.log("Poll response:", data);
                    if (!data.processing) {
                        clearInterval(pollInterval);
                        displaySuggestedEvents(data.suggested_events);
                        document.getElementById("ai-response").textContent = "New events received!";
                    } else {
                        console.log("LLM still generating...");
                    }
                })
                .catch(err => {
                    console.error("Polling error:", err);
                });
        }, 1500);
    }

    function submitEditedEvent(idx) {
        const title = document.getElementById(`title-${idx}`).value;
        const start = document.getElementById(`start-${idx}`).value;
        const end = document.getElementById(`end-${idx}`).value;
        const location = document.getElementById(`location-${idx}`).value;
        const description = document.getElementById(`description-${idx}`).value;

        if (!title || !start || !end) {
            alert("Missing required fields.");
            return;
        }

        if (new Date(start) >= new Date(end)) {
            alert("End time must be after start time.");
            return;
        }

        fetch('/add-event/', {
            method: 'POST',
            headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
            },
            body: new URLSearchParams({
            title,
            start: new Date(start).toISOString(),
            end: new Date(end).toISOString(),
            location,
            description
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.message) {
            alert("Event submitted!");
            } else {
            alert("ERROR" + (data.error || "Submission failed."));
            }
        })
        .catch(err => {
            console.error("Error submitting event:", err);
            alert("Submission failed.");
        });
        }

    </script>
    <script>
    {% if not user.is_authenticated %}
    document.addEventListener('DOMContentLoaded', function () {
        const calendarEl = document.getElementById('calendar');
        if (calendarEl) {
            const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            height: 'auto',
            headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            events: []
        });
        calendar.render();
        }
    });
    {% endif %}
    </script>
    <script> 
    {% if not user.is_authenticated %}
    document.addEventListener("DOMContentLoaded", function () {
        const guestForm = document.getElementById("guest-ai-form");
        const guestResponse = document.getElementById("guest-ai-response");
        const guestTable = document.getElementById("guest-ai-table");
        const guestTableBody = guestTable.querySelector("tbody");

        guestForm.addEventListener("submit", function (e) {
            e.preventDefault();

            const query = document.getElementById("guest-ai-input").value.trim();
            const file = document.getElementById("guest-ai-file").files[0];

            if (!query && !file) {
                alert("Please enter a message or upload a PDF.");
                return;
            }

            const formData = new FormData();
            formData.append("query", query);
            if (file) formData.append("file", file);

            fetch("/guest-ai-query/", {
                method: "POST",
            body: formData
            })
            .then(res => res.json())
            .then(data => {
                guestResponse.classList.remove("d-none");

                if (data.error) {
                    guestResponse.classList.add("alert-danger");
                    guestResponse.classList.remove("alert-info");
                    guestResponse.innerText = "WRONG" + data.error;
                    guestTable.classList.add("d-none");
                    guestTableBody.innerHTML = "";
                } else if (data.events && data.events.length > 0) {
                    guestResponse.classList.remove("alert-danger");
                    guestResponse.classList.add("alert-info");
                    guestResponse.innerText = "Events successfully extracted:";

                    guestTableBody.innerHTML = "";
                    function formatDateTime(isoString) {
                        const dt = new Date(isoString);
                        return `${dt.toLocaleDateString()}<br><small>${dt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</small>`;
                    }
                    data.events.forEach(event => {
                        const row = document.createElement("tr");
                        row.innerHTML = `
                            <td>${event.title}</td>
                            <td>${formatDateTime(event.start)}</td>
                            <td>${formatDateTime(event.end)}</td>
                            <td>${event.location}</td>
                            <td>${event.description}</td>
                        `;
                        guestTableBody.appendChild(row);
                    });

                    guestTable.classList.remove("d-none");
                } else {
                    guestResponse.classList.remove("alert-danger");
                    guestResponse.classList.add("alert-info");
                    guestResponse.innerText = "No events found.";
                    guestTable.classList.add("d-none");
                    guestTableBody.innerHTML = "";
                }
            })
            .catch(err => {
                guestResponse.classList.remove("alert-info");
                guestResponse.classList.add("alert-danger");
                guestResponse.classList.remove("d-none");
                guestResponse.innerText = "Error: " + err;
                guestTable.classList.add("d-none");
                guestTableBody.innerHTML = "";
            });
        });
    });
    {% endif %}
    </script>        
    
{% endblock %}
